<html>

<head>
    <script src="http://d3js.org/d3.v6.min.js" charset="utf-8"></script>
</head>

<body>
    <script type="text/javascript">
        var width = 700;
        var height = 900;

        var margin = {
            left: 30,
            right: 30,
            bottom: 30,
            top: 30
        }

        const svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        d3.csv("us-population-state-age.csv", d3.autoType).then(function(data) {
            // Fixing name of 80+ column such that it can be typed on keyboard
            data.forEach(row => {
                row["80+"] = row["≥80"];
                delete row["≥80"];
            });

            // Adding total population to data
            for (var i = 0; i < data.length; i++) {
                var pop = 0;

                Object.keys(data[i]).filter(k => k !== "name").forEach(k => {
                    pop = pop + data[i][k]
                })

                data[i].population = pop;
            }

            // Set scales and axes
            xScale = d3.scaleLinear(
                [0, d3.max(data, d => d.population)],
                [margin.left, width - margin.right]
            );

            yScale = d3.scaleBand(
                data.map(d => d.name),
                [height - margin.bottom, margin.top]
            ).padding(0.2);

            xAxis = d3.axisBottom(xScale);
            yAxis = d3.axisLeft(yScale);

            var stackKeys = Object.keys(data[0]).filter(k => k !== "name" && k !== "population");

            // Create color scheme based on stack keys
            color = d3.scaleLinear(
                [0, stackKeys.length - 1],
                [d3.schemeBuGn[9][2], d3.schemeBuGn[9][8]]
            )

            stack = d3.stack()
                .keys(stackKeys);

            stackedData = stack(data);

            // Adding groups for each band type
            var groups = svg.append("g")
                .attr("class", "vis-container")
                .selectAll("g")
                .data(stackedData)
                .join("g")
                    .attr("class", (d, i) => `${stackKeys[i]}-bands`)
                    .attr("fill", (d, i) => color(i));

            d3.select(".vis-container").selectAll("g").selectAll("rect")
                .data(d => d)
                .join("rect")
                    .attr("x", d => xScale(d[0]))
                    .attr("y", d => {
                        console.log(yScale(d.data.name))
                        return yScale(d.data.name)
                    })
                    .attr("width", d => xScale(d[1]) - xScale(d[0]))
                    .attr("height", yScale.bandwidth())

            // console.log(stackedData)
        });
    </script>
</body>

</html>